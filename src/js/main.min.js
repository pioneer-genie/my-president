async function fetchSurveyData(){try{const e=await fetch("src/data/promises.json");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const n=await e.json();return Object.entries(n).map((([e,n])=>({topic:e,choices:shuffleArray([...Object.entries(n).map((([e,n],t)=>({candidate:e,text:n.요약,original:n.원본,originalPosition:t+1})))]).map(((e,n)=>({...e,displayPosition:n+1}))),showOriginal:!1})))}catch(e){return console.error("설문 데이터를 불러오는데 실패했습니다:",e),[]}}function showModal(e,n){const t=`\n        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">\n            <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">\n                <div class="flex justify-between items-center mb-4">\n                    <h2 class="text-xl font-bold">${e} - 상세 공약</h2>\n                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">\n                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>\n                        </svg>\n                    </button>\n                </div>\n                <div class="space-y-4">\n                    ${n.map((e=>`\n                        <div class="border-b pb-4">\n                            <h3 class="font-semibold text-lg mb-2">${e.candidate}</h3>\n                            <div class="space-y-2">\n                                ${e.original.map((e=>`\n                                    <p class="text-gray-700">${e}</p>\n                                `)).join("")}\n                            </div>\n                        </div>\n                    `)).join("")}\n                </div>\n            </div>\n        </div>\n    `,r=document.createElement("div");r.id="modal-container",r.innerHTML=t,document.body.appendChild(r)}function createSurveyCard(e,n,t){return`\n        <div class="mb-8">\n            <div class="flex justify-between items-center mb-4">\n                <h2 class="text-xl font-semibold">${e}</h2>\n                <button \n                    onclick="toggleOriginal('${e}')"\n                    class="text-blue-600 hover:text-blue-800 text-sm font-medium"\n                >\n                    ${t?"요약 보기":"자세히 보기"}\n                </button>\n            </div>\n            <div class="space-y-3">\n                ${n.map(((e,n)=>`\n                    <button \n                        class="w-full p-4 text-left border rounded-lg hover:bg-gray-50 transition-colors"\n                        data-candidate="${e.candidate}"\n                        onclick="window.selectAnswer('${e.candidate}', ${e.originalPosition}, ${e.displayPosition})"\n                    >\n                        ${t?e.original.map(((e,n)=>`\n                                <div class="${n>0?"border-t border-gray-200 pt-2 mt-2":""}">\n                                    <p class="text-gray-700">${e}</p>\n                                </div>\n                            `)).join(""):e.text}\n                    </button>\n                `)).join("")}\n                <button \n                    class="w-full p-4 text-left border rounded-lg hover:bg-gray-50 transition-colors text-gray-500"\n                    data-candidate="none"\n                    onclick="window.selectAnswer('none', 0, ${n.length+1})"\n                >\n                    마음에 드는 내용이 없음\n                </button>\n            </div>\n        </div>\n    `}function renderQuestion(){const e=surveyData[currentQuestion],n=document.getElementById("survey-container");n?n.innerHTML=`\n        <div class="mb-4">\n            <div class="w-full bg-gray-200 rounded-full h-2">\n                <div class="bg-blue-600 h-2 rounded-full" style="width: ${currentQuestion/surveyData.length*100}%"></div>\n            </div>\n            <p class="text-sm text-gray-600 mt-2">${currentQuestion+1} / ${surveyData.length}</p>\n        </div>\n        ${createSurveyCard(e.topic,e.choices,e.showOriginal)}\n    `:console.error("survey-container를 찾을 수 없습니다.")}window.closeModal=function(){const e=document.getElementById("modal-container");e&&e.remove()},window.toggleOriginal=function(e){const n=surveyData.findIndex((n=>n.topic===e));-1!==n&&(surveyData[n].showOriginal=!surveyData[n].showOriginal,renderQuestion())},window.selectAnswer=function(e,n,t){gtag("event","survey_answer",{event_category:"survey",event_label:"answer_selected",step:currentQuestion+1,total_steps:surveyData.length,selected_candidate:e,original_position:n,display_position:t});const r=JSON.parse(localStorage.getItem("surveyAnswers")||"[]");r.push({candidate:e,originalPosition:n,displayPosition:t,selectedPosition:currentQuestion+1}),localStorage.setItem("surveyAnswers",JSON.stringify(r)),currentQuestion++,currentQuestion<surveyData.length?renderQuestion():showResults()};const candidateMapping={"이재명":"A","김문수":"B","이준석":"C"},reverseCandidateMapping={A:"이재명",B:"김문수",C:"이준석",N:"none"},candidateOrder=["이재명","김문수","이준석"];function shuffleArray(e){for(let n=e.length-1;n>0;n--){const t=Math.floor(Math.random()*(n+1));[e[n],e[t]]=[e[t],e[n]]}return e}const resultCipher={encrypt:function(e){return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")},decrypt:function(e){try{const n=e.replace(/-/g,"+").replace(/_/g,"/");return atob(n)}catch(e){return console.error("결과 복호화 실패:",e),""}}};let surveyData=[],currentQuestion=0;async function init(){try{if(surveyData=await fetchSurveyData(),0===surveyData.length)throw new Error("설문 데이터를 불러오는데 실패했습니다.");const e=new URLSearchParams(window.location.search).get("r");if(e){gtag("event","survey_result_view",{event_category:"survey",event_label:"result_page_view",result_param:e});const n=resultCipher.decrypt(e);if(!n)throw new Error("잘못된 결과 URL입니다.");const t=[];for(let e=0;e<n.length;e+=2){const r=n[e],o=n[e+1];t.push({candidate:reverseCandidateMapping[o],displayPosition:parseInt(r)})}localStorage.setItem("surveyAnswers",JSON.stringify(t)),currentQuestion=surveyData.length,showResults()}else gtag("event","survey_start",{event_category:"survey",event_label:"survey_started",total_steps:surveyData.length}),localStorage.removeItem("surveyAnswers"),renderQuestion()}catch(e){console.error("초기화 중 오류 발생:",e),document.getElementById("survey-container").innerHTML=`\n            <div class="text-center text-red-600">\n                ${e.message||"오류가 발생했습니다."}\n            </div>\n        `}}function showResults(){const e=JSON.parse(localStorage.getItem("surveyAnswers")||"[]"),n={};e.forEach((e=>{"none"!==e.candidate&&(n[e.candidate]=(n[e.candidate]||0)+1)}));const t=Object.entries(n).sort(((e,n)=>n[1]-e[1])),r=t[0]?.[1]||0,o=t.filter((([e,n])=>n===r)).map((([e])=>e)).sort(((e,n)=>candidateOrder.indexOf(e)-candidateOrder.indexOf(n))),s=document.getElementById("survey-container");if(!s)return void console.error("survey-container를 찾을 수 없습니다.");const a=e.map((e=>`${e.displayPosition}${"none"===e.candidate?"N":candidateMapping[e.candidate]}`)).join(""),i=resultCipher.encrypt(a),l=`${window.location.origin}${window.location.pathname}?r=${i}`,c={"이재명":"#008CCD","김문수":"#D22739","이준석":"#F47923"};s.innerHTML=`\n        <div class="text-center px-2 sm:px-4 py-8 rounded-lg" style="background-color: ${1===o.length?c[o[0]]+"10":"#f8f9fa"}">\n            <h2 class="text-2xl font-bold mb-4">결과</h2>\n            ${0===o.length?'<p class="text-xl mb-6">마음에 드는 공약이 없었습니다.</p>':`<div class="mb-8">\n                    <p class="text-xl mb-6">\n                        ${1===o.length?`나와 가장 맞는 후보는 <span class="font-bold" style="color: ${c[o[0]]}">${o[0]}</span>입니다!`:`나와 가장 맞는 후보들은 <span class="font-bold">${o.map((e=>`<span style="color: ${c[e]}">${e}</span>`)).join(", ")}</span>입니다!<br><span class="text-lg text-gray-600">박빙이네요! 동점입니다.</span>`}\n                    </p>\n                    \x3c!-- 후보자 포스터 표시 --\x3e\n                    <div class="flex justify-center gap-4">\n                        ${o.map((e=>`\n                            <div class="w-1/${o.length}">\n                                <img \n                                    src="${"이재명"===e?"no1.jpg":"김문수"===e?"no2.jpg":"no4.jpg"}" \n                                    alt="${e} 후보 포스터"\n                                    class="mx-auto w-full max-w-[280px] sm:max-w-sm rounded-lg shadow-lg"\n                                >\n                            </div>\n                        `)).join("")}\n                    </div>\n                </div>`}\n\n            <div class="mb-8">\n                <h3 class="text-lg font-semibold mb-4">상세 점수</h3>\n                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">\n                    ${candidateOrder.map((e=>`\n                        <div class="p-4 rounded-lg border" style="border-color: ${c[e]}40; background: ${c[e]}10">\n                            <p class="font-semibold mb-2" style="color: ${c[e]}">${e}</p>\n                            <p class="text-2xl font-bold" style="color: ${c[e]}">${n[e]||0}점</p>\n                        </div>\n                    `)).join("")}\n                </div>\n            </div>\n\n            <div class="space-y-4">\n                <div class="flex flex-col sm:flex-row gap-4 justify-center">\n                    <button \n                        class="bg-yellow-400 text-black px-6 py-3 rounded-full font-semibold hover:bg-yellow-500 transition-colors"\n                        onclick="window.shareResult()"\n                    >\n                        결과 공유하기\n                    </button>\n                    <button \n                        class="bg-gray-200 text-gray-700 px-6 py-3 rounded-full font-semibold hover:bg-gray-300 transition-colors"\n                        onclick="window.restartSurvey()"\n                    >\n                        다시하기\n                    </button>\n                </div>\n                <div class="mt-4">\n                    <p class="text-sm text-gray-600 mb-2">또는 아래 링크를 공유하세요:</p>\n                    <div class="relative">\n                        <input \n                            type="text" \n                            value="${l}" \n                            readonly \n                            class="w-full p-2 pr-10 border rounded text-sm"\n                            onclick="this.select()"\n                        >\n                        <button \n                            onclick="window.copyToClipboard('${l}')"\n                            class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"\n                            title="클립보드에 복사"\n                        >\n                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />\n                            </svg>\n                        </button>\n                    </div>\n                </div>\n            </div>\n\n            \x3c!-- 카테고리별 선택 내역 테이블 --\x3e\n            <div class="mt-12">\n                <h3 class="text-lg font-semibold mb-4">카테고리별 공약 비교</h3>\n                <div class="overflow-x-auto -mx-2 sm:mx-0">\n                    <table class="min-w-full bg-white border border-gray-200 rounded-lg">\n                        <thead>\n                            <tr class="bg-gray-50">\n                                <th class="px-2 sm:px-4 py-2 sm:py-3 border-b text-center text-xs sm:text-sm font-semibold text-gray-600">카테고리</th>\n                                ${candidateOrder.map((e=>`\n                                    <th class="px-2 sm:px-4 py-2 sm:py-3 border-b text-center text-xs sm:text-sm font-semibold" style="color: ${c[e]}">${e}</th>\n                                `)).join("")}\n                            </tr>\n                        </thead>\n                        <tbody class="divide-y divide-gray-200">\n                            ${surveyData.map(((n,t)=>{const r=e[t];return`\n                                    <tr class="hover:bg-gray-50">\n                                        <td class="px-2 sm:px-4 py-2 sm:py-4 text-xs sm:text-sm font-medium text-gray-900 border-r text-center">${n.topic}</td>\n                                        ${candidateOrder.map((e=>{const t=n.choices.find((n=>n.candidate===e)),o=r.candidate===e,s=t&&t.text;return`\n                                                <td class="px-2 sm:px-4 py-2 sm:py-4 text-xs sm:text-sm ${s?"text-gray-900":"text-gray-400 bg-gray-50"} ${o?"bg-green-50":""} text-center" style="${o?`border: 2px solid ${c[e]}`:""}">\n                                                    <div class="max-w-[120px] sm:max-w-md mx-auto">\n                                                        ${s?t.text:"공약 정보 없음"}\n                                                    </div>\n                                                </td>\n                                            `})).join("")}\n                                    </tr>\n                                `})).join("")}\n                        </tbody>\n                    </table>\n                </div>\n            </div>\n        </div>\n    `}document.addEventListener("DOMContentLoaded",init),window.shareResult=async function(){const e=document.querySelector("input[readonly]").value.split("r=")[1];gtag("event","share_result",{event_category:"engagement",event_label:"share_button_click",result_param:e||"none"});const n={title:"나와 맞는 대선 후보 찾기",text:"나와 맞는 대선 후보를 찾아보세요!",url:window.location.href};try{if(navigator.share)await navigator.share(n);else{document.querySelector("input[readonly]").select(),document.execCommand("copy"),alert("링크가 복사되었습니다. 원하는 곳에 붙여넣기 해주세요.")}}catch(e){console.error("공유하기 실패:",e);document.querySelector("input[readonly]").select(),document.execCommand("copy"),alert("링크가 복사되었습니다. 원하는 곳에 붙여넣기 해주세요.")}},window.copyToClipboard=function(e){const n=e.split("r=")[1];gtag("event","share_result",{event_category:"engagement",event_label:"copy_link_click",result_param:n||"none"});const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t);try{t.select(),t.setSelectionRange(0,t.value.length);if(!document.execCommand("copy"))throw new Error("복사 실패");{const e=event.currentTarget,n=e.innerHTML;e.innerHTML='\n                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />\n                </svg>\n            ',setTimeout((()=>{e.innerHTML=n}),2e3)}}catch(e){console.error("클립보드 복사 실패:",e),alert("클립보드 복사에 실패했습니다. 직접 복사해주세요.")}finally{document.body.removeChild(t)}},window.restartSurvey=function(){const e=document.querySelector("input[readonly]").value.split("r=")[1];gtag("event","restart_survey",{event_category:"engagement",event_label:"retry_button_click",result_param:e||"none"}),localStorage.removeItem("surveyAnswers"),currentQuestion=0,window.history.replaceState({},document.title,window.location.pathname),renderQuestion()};